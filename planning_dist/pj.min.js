/*!
 * Proxim Jardin Planning
 * Version: 20.2 16/01/22
 * auteur: Mickael Feuvrier
 * Copyright (c) 2019 - 2022 Proxim Jardin ALL RIGHTS RESERVED
* auteur Mickael FEUVRIER*/ $(()=>{let e=new URL(document.location),t=e.searchParams,a=t.get("a"),i;i=a?[a]:["1","2","3"],$("<div />").attr("id","container").appendTo("#planning"),$("<div />").attr("id","drawer").appendTo("#planning"),$("<div />").attr("id","toolbar").appendTo("#drawer"),$("<div />").attr("id","popup-semaine").appendTo("#planning"),$("<div />").attr("id","toastContainer").appendTo("#planning"),$("<div />").attr("id","context-menu").appendTo("#planning"),$("<div />").attr("id","scheduler").appendTo("#drawer");class o{constructor(e,t){this.type=e,this.value=t}}class n{constructor(e,t){if(void 0!==t)return t;return $.grep(f._array,t=>t.id===e)[0].defautSalId}}let l=[],d=[],s=[],p=[],c=[],u=null,m=$(window).height(),h=new DevExpress.data.ArrayStore({data:l,key:"id",onUpdated(e,t){result=JSON.stringify(new o("update",t)),ee("maj_Appointment",result)}}),v=new DevExpress.data.DataSource({store:h,paginate:!1,reshapeOnPush:!0}),b=new DevExpress.data.ArrayStore({data:d,key:"id"});new DevExpress.data.DataSource({store:b,paginate:!1,reshapeOnPush:!0});let x=new DevExpress.data.ArrayStore({data:s,key:"id"}),g=new DevExpress.data.DataSource({store:x,paginate:!1,reshapeOnPush:!0}),f=new DevExpress.data.ArrayStore({data:p,key:"id"}),y=new DevExpress.data.ArrayStore({data:c,key:"id"}),_=new DevExpress.data.DataSource({store:y,sort:"clt_nom",paginate:!0});Q("planning","Office",U(new Date),"startDate",R),Q("planning","Appointment",Y(new Date),"date",A),Q("planning","Salarie","","",E),Q("planning","Equipe","","",B),X("datajardin","client_API"),DevExpress.localization.locale(navigator.language),DevExpress.localization.formatMessage;let w=$("#drawer").dxDrawer({opened:!1,height:m,elementAttr:{class:"drawer-planning"},width:"100%",closeOnOutsideClick:!1,openedStateMode:"overlap",template(){let e=$("<div/>",{class:"panel-accordion",height:"100%",width:"80vw"}),t=$("<div />",{id:"toolbar_drawer"}),a=$("<div />",{class:"panel-content-accordion"});buttonOption=$("<div />",{class:"bt-option"}),e.append(t),e.append(a),a.append(buttonOption);let i=$("<div />").dxButton({text:"Contact",type:"normal",width:200,icon:"ja-add-team",elementAttr:{class:"button-option"},onClick(){I({param:{func:S,param:"",title:"Contact"}})}});return i.appendTo(buttonOption),e},onOptionChanged(){let e=$(".buttonPanel");e.hasClass("panelOpened")?e.removeClass("panelOpened"):e.addClass("panelOpened")}}).dxDrawer("instance");$("#toolbar_drawer").dxToolbar({elementAttr:{class:"toolbar_drawer"},items:[{widget:"dxButton",location:"after",options:{icon:"close-panel",onClick(){w.toggle(),$(".dx-drawer-panel-content .dx-overlay-content").removeClass("ja-shadow")},elementAttr:{class:"buttonPanel"}}}]}).dxToolbar("instance"),$("#toolbar").dxToolbar({elementAttr:{class:"toolbar_header"},items:[{widget:"dxButton",location:"before",options:{icon:"menu",onClick(){w.toggle(),$(".dx-drawer-panel-content .dx-overlay-content").addClass("ja-shadow")},elementAttr:{class:"buttonPanel"}}}]}).dxToolbar("instance");let D=$("#scheduler").dxScheduler({height:"100vh",dataSource:v,groupByDate:!0,firstDayOfWeek:1,startDayHour:8,endDayHour:18.5,currentView:"day",editing:{allowAdding:!1,allowDeleting:!1,allowUpdating:!0,allowResizing:!1,allowDragging:!1},useDropDownViewSwitcher:!1,showAllDayPanel:!1,showCurrentTimeIndicator:!1,crossScrollingEnabled:!1,adaptivityEnable:!0,groups:["equipeID"],views:[{type:"day"}],resources:[{key:"equipeID",fieldExpr:"equipeID",allowMultiple:!1,dataSource:J(i),label:"Equipe"},{fieldExpr:"salarieID",allowMultiple:!0,dataSource:x,label:"Salari\xe9"},{fieldExpr:"statut",label:"Statut",dataSource:[{text:"Rendez-vous"},{text:"Message"},{text:"Non appel\xe9"},{text:"D\xe9faut"}]}],onAppointmentRendered(){L()},timeCellTemplate(e,t,a){a.text(e.text).css({color:"#469f11",height:G()})},appointmentTemplate(e){let t=new Date(e.appointmentData.startDate).toLocaleTimeString(),a=new Date(e.appointmentData.endDate).toLocaleTimeString(),i,o,n=$("<div/>"),l=e.appointmentData.salarieID;switch(e.appointmentData.statut){case"Rendez-vous":i="rdv";break;case"Message":i="mes";break;case"Non appel\xe9":i="na";break;default:i="def"}o=void 0===e.appointmentData.statut?"":e.appointmentData.statut;let d=$("<div />").addClass(`app-content ${i}`);$("<div />").addClass("strong").text(e.appointmentData.devis.text).appendTo(d),$("<div />").addClass("app-hour").text(`${t.slice(0,-3)} - ${a.slice(0,-3)}`).appendTo(d),$("<div />").addClass("app-statut").text(o).appendTo(d);let s=$("<div />").addClass("member").appendTo(d);return l.forEach(()=>{$("<i />").addClass("dx-icon user-icon dx-icon-user").appendTo(n)}),n.appendTo(s),d},dataCellTemplate(e,t,a){a.css("height",G()),12==e.startDate.getHours()&&a.addClass("dx-template-Pose");let i=e.startDate.getTime(),o=e.groups.equipeID;b.load().done(e=>{for(let[t,n]of e.entries()){let l=new Date(e[t].startDate),d;switch(e[t].periodeID){case 1:d=(l=l.getTime()+288e5)+144e5;break;case 2:d=(l=l.getTime()+468e5)+18e6;break;case 3:d=(l=l.getTime()+288e5)+432e5}l<=i&&d>=i&&3==o&&a.addClass("dx-template-Office")}})},onAppointmentClick(e){e.cancel=!0,e.component.showAppointmentPopup(e.appointmentData)},onAppointmentFormOpening(e){e.form.option({animation:W(),labelMode:"floating",items:T(e)}),e.popup.option({animation:W(),minWidth:"100%",height:"100%",showCloseButton:!0,showTitle:!0,toolbarItems:[]})},onOptionChanged(e){"currentDate"===e.name&&(D.repaint(),D.on([{repaint:z()}]),Q("planning","Appointment",Y(D.option("currentDate")),"date",A),Q("planning","Office",U(D.option("currentDate")),"startDate",R))},customizeDateNavigatorText:e=>["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"][e.startDate.getDay()]+" "+e.text}).dxScheduler("instance");function T(e){if(!e.appointmentData.devis.dvs_ref)return[{itemType:"group",cssClass:"adresse-group",colSpan:5,items:[{dataField:"devis.text",label:{text:"Nom",visible:!1},editorType:"dxTextBox",editorOptions:{readOnly:!0,placeholder:"Nom",width:"100%",type:"text"}},{name:"description",dataField:"devis.description",label:{text:"Description",visible:!1},editorType:"dxTextArea",editorOptions:{readOnly:!0,displayExpr:"text",elementAttr:{id:"description"}}},{name:"observation",dataField:"observation",label:{text:"Observation",visible:!1},editorType:"dxTextArea",editorOptions:{displayExpr:"text",elementAttr:{id:"observation"}}}]}];{let t=[{itemType:"group",cssClass:"arrdep-group",colCountByScreen:{xs:1},colSpan:2,items:V(e)},{itemType:"group",cssClass:"adresse-group",colCountByScreen:{xs:5},colSpan:2,items:[{dataField:"devis.client_nom_prenom",label:{text:"Nom",visible:!1},colSpan:3,editorType:"dxTextBox",editorOptions:{readOnly:!0,placeholder:"Nom",width:"100%",type:"text"}},{dataField:"devis.dvs_num",label:{text:"N\xb0 de devis",visible:!1},colSpan:2,editorType:"dxTextBox",editorOptions:{readOnly:!0,placeholder:"N\xb0 de devis",width:"100%",type:"text"}}]},{dataField:"startDate",visible:!1,label:{text:"date de d\xe9but",visible:!1},editorType:"dxDateBox",editorOptions:{placeholder:"date de d\xe9but",width:"100%",type:"datetime"}},{name:"endDate",dataField:"endDate",visible:!1,label:{text:"date de fin",visible:!1},editorType:"dxDateBox",editorOptions:{placeholder:"date de fin",width:"100%",type:"datetime"}},{itemType:"group",cssClass:"adresse-group",colCountByScreen:{xs:3},colSpan:2,items:[{name:"adresse",dataField:"devis.adresse.adrch",colSpan:3,label:{text:"Adresse chantier",visible:!1},editorOptions:{disabled:!1,readOnly:!0}},{dataField:"devis.adresse.adrch_ville",colSpan:2,label:{text:"Ville",visible:!1},editorOptions:{disabled:!1,readOnly:!0}},{colSpan:1,name:"button_map",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"50%",text:"map",type:"success",elementAttr:{class:"button-map"},onClick(){window.open(`https://local.google.com/maps?q=${e.appointmentData.devis.adresse.adrch},${e.appointmentData.devis.adresse.adrch_ville},,${e.appointmentData.devis.adresse.adrch_cp},France`,"_blank")}}}]},{itemType:"group",cssClass:"num-tel",colCountByScreen:{xs:2},colSpan:2,items:[{name:"tel",dataField:"devis.client.tel",colSpan:1,label:{text:"T\xe9l\xe9phone",visible:!1},editorOptions:{disabled:!1,readOnly:!0}},{dataField:"devis.client.tel2",colSpan:2,label:{text:"T\xe9l\xe9phone",visible:!1},editorOptions:{disabled:!1,readOnly:!0}}]},{name:"salari\xe9",dataField:"salarieID",label:{text:"Salari\xe9s",visible:!1},colSpan:1,editorType:"dxTextArea",editorOptions:{displayExpr:"text",autoResizeEnabled:!0,text:q(e),readOnly:!0,elementAttr:{id:"salarie"}}},{dataField:"statut",label:{text:"statut",visible:!1},colSpan:2,editorType:"dxTextBox",editorOptions:{readOnly:!0,placeholder:"statut",width:"100%",type:"text"}},{itemType:"group",colSpan:2,colCountByScreen:{xs:6},items:[{name:"button_detail",colSpan:3,label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"d\xe9tail",type:"success",elementAttr:{class:"button-detail"},visible:!0,onClick(){I({param:{func:O,param:e,title:"D\xe9tail du devis"}})}}},{name:"button_suivi",colSpan:3,label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"suivi de chantier",type:"success",elementAttr:{class:"button-suivi"},visible:!0,onClick(){I({param:{func:F,param:e,title:"Temps pass\xe9 sur le chantier"}})}}}]}];return t}}function S(){return{contentTemplate(){let e=$("<div />").addClass("wrapper-grid-contact-popup");return e.dxList({dataSource:_,scrolling:{mode:"infinite"},height:"300px",itemTemplate(e,t,a){a.append($("<b>").text(e.clt_nom),$("<br />"))},searchEnabled:!0,searchExpr:["clt_nom"],searchMode:"contains",pageLoadMode:"scrollBottom",onItemClick(e){Z("datajardin","client_API",e.itemData.clt_ref,"clt_ref")}}),e},toolbarItems:[{visible:!1}]}}function C(e){return{contentTemplate(){let t=$("<div />").addClass("wrapper-Client-popup").dxScrollView({width:"100%",height:"100%"});return t.dxForm({formData:e,items:[{itemType:"group",cssClass:"nom-group",colCountByScreen:{xs:3},items:[{dataField:"clt_civi",colSpan:1,label:{text:"Civilit\xe9",visible:!1}},{dataField:"clt_nom_prenom",colSpan:2,label:{text:"pr\xe9nom",visible:!1}}]},{itemType:"group",cssClass:"adress-group",colCountByScreen:{xs:3},items:[{dataField:"clt_adres(1)",colSpan:3,label:{text:"adressse",visible:!1}},{dataField:"clt_CP",colSpan:1,label:{text:"cp",visible:!1}},{dataField:"clt_ville",colSpan:2,label:{text:"ville",visible:!1}}]},{itemType:"group",cssClass:"adress-group",colCountByScreen:{xs:2},items:[{dataField:"clt_tel(1)",colSpan:1,label:{text:"tel",visible:!1}},{dataField:"clt_mail(1)",colSpan:1,label:{text:"mail",visible:!1}},{dataField:"clt_tel(2)",colSpan:1,label:{text:"tel2",visible:!1}},{dataField:"clt_mail(2)",colSpan:1,label:{text:"mail2",visible:!1}},{dataField:"clt_tel(3)",colSpan:1,label:{text:"tel3",visible:!1}},{dataField:"clt_mail(3)",colSpan:1,label:{text:"mail3",visible:!1}}]}]}).dxForm("instance"),t}}}function O(e){return{contentTemplate(){let t=$("<div />"),a=$("<div />").addClass("wrapper-info-devis-form").css("margin-bottom","80px").appendTo(t),i=$("<div />").attr("id","contenu_treelist_devis").addClass("container-cont").appendTo(a),o=$("<div />").attr("id","contenu_observation_devis").css("margin-top","20px").addClass("container-cont").appendTo(a),n=$("<div />").addClass("toolbar-time-result ja-toolbar").appendTo(a),l=i.dxTreeList({dataSource:e.appointmentData.devis.detail.cont,itemsExpr:"sub_cont",dataStructure:"tree",columns:[{dataField:"descr",caption:"Description",cellTemplate(e,t){let a=t.data.descr;e.append($("<span>",{class:"descr",html:a}))}},{dataField:"h_prevu",caption:"H"}],selection:{mode:"multiple",recursive:!0},autoExpandAll:!0,showRowLines:!0,showBorders:!0,columnAutoWidth:!0,wordWrapEnabled:!0,onRowPrepared(e){(0==e.level||"header"===e.rowType)&&e.rowElement.find("td").css("font-weight","1000")},onCellPrepared(e){"data"==e.rowType&&0==e.row.level&&e.cellElement.find("div.dx-treelist-icon-container").remove()},onNodesInitialized(e){let t=[];l.forEachNode(e=>{let a=e.data;if(1===a.termine){let i=a.id;t.push(i)}}),l.option("selectedRowKeys",t)}}).dxTreeList("instance");return o.dxForm({readOnly:!1,showColonAfterLabel:!0,labelMode:"floating",labelLocation:"top",minColWidth:200,height:"auto",colCount:1,showValidationSummary:!1,validationGroup:"formTimeResult",items:[{name:"observation",dataField:"observation",label:{text:"Observation",visible:!1},colSpan:1,editorType:"dxTextArea",editorOptions:{displayExpr:"text",elementAttr:{id:"observation"}}}]}),n.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"before",options:{stylingMode:"contained",type:"success",text:"valider",onClick(){let t=l.getSelectedRowKeys("leavesOnly");$.each(e.appointmentData.devis.detail.cont,(e,a)=>{$.each(a.sub_cont,(e,a)=>{t.includes(a.id)?a.termine=1:a.termine=0})}),e.component.updateAppointment(e.appointmentData,e.appointmentData);let a={};a.data=t,a.structure=e.appointmentData.devis.structure,a.dvs_ref=e.appointmentData.devis.dvs_ref,ee("scdvsTermine",a=JSON.stringify(a)),u.hide()}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",stylingMode:"contained",type:"success",onClick(){u.hide()}}}]}).dxToolbar("instance"),t.dxScrollView({height:"100%",width:"100%"}).dxScrollView("instance"),t}}}function F(e){return console.log(e),{contentTemplate(){let t=$("<div />");$("<div />").appendTo(t);let a=$("<div />").appendTo(t),i=$("<div />").addClass("toolbar-time-result ja-toolbar").appendTo(t),o,n;o=(n=!!e.appointmentData.sdc&&0!=e.appointmentData.sdc.length)?e.appointmentData.sdc:[];let l=K(new Date(e.appointmentData.startDate)),d=e.appointmentData.devis.dvs_ref;n||$.each(e.appointmentData.salarieID,(e,t)=>{let a={};x.load({filter:["id",t]}).done(e=>{let t=`${e[0].prenom} ${e[0].nom}`;a.salarie_name=t,a.dvs_ref=d,a.date=l}),o.push(a)});let s=a.dxDataGrid({dataSource:o,showBorders:!0,columnHidingEnabled:!0,editing:{mode:"popup",allowUpdating:j(o[0].date,o[0].heure_a),allowAdding:j(o[0].date,o[0].heure_a),allowDeleting:j(o[0].date,o[0].heure_a),popup:{showTitle:!1,fullScreen:!0},form:{items:[{itemType:"group",colSpan:2,colCount:2,items:[{dataField:"salarie_name",editorType:"dxSelectBox",editorOptions:{dataSource:g,valueExpr(e){if(null!=e)return`${e.prenom} ${e.nom}`},displayExpr(e){if(null!=e)return`${e.prenom} ${e.nom}`}}},{dataField:"date"}]},{itemType:"group",colSpan:2,colCount:3,items:[{dataField:"heure_a"},{dataField:"heure_d"},{dataField:"trajet"}]},{itemType:"group",colCount:2,items:[{dataField:"pause_a"},{dataField:"pause_d"}]}]}},columns:[{allowEditing:!1,dataField:"appointmentID",visible:!1},{allowEditing:!0,dataField:"date",visible:!0},{dataField:"salarie_name",caption:"Nom",validationRules:[{type:"required",message:"requis"}]},{dataField:"heure_a",caption:"heure d'arriv\xe9e",editorOptions:{mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"heure_d",caption:"heure de d\xe9part",editorOptions:{mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"trajet",caption:"temps de trajet",validationRules:[{type:"required",message:"requis"}]},{dataField:"pause_a",caption:"d\xe9but de pause",editorOptions:{mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"pause_d",caption:"fin de pause",editorOptions:{mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"}}],onRowInserting(e){e.data.date=l,e.data.dvs_ref=d,e.data.pause_a||(e.data.pause_a=""),e.data.pause_d||(e.data.pause_d="")}}).dxDataGrid("instance");return n?(i.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"before",options:{text:"valider",stylingMode:"contained",type:"success",onClick(){let t=s.option("dataSource");if(0==t.length)e.component.updateAppointment(e.appointmentData,$.extend(e.appointmentData,{sdc:t})),ee("createSuiviChantier",t=JSON.stringify(t)),u.hide();else{e.component.updateAppointment(e.appointmentData,$.extend(e.appointmentData,{sdc:t}));let a={};a.data=t,a.structure=e.appointmentData.devis.structure,a.appointmentID=e.appointmentData.id,ee("createSuiviChantier",a=JSON.stringify(a)),u.hide()}}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",stylingMode:"contained",type:"success",onClick(){u.hide()}}}]}).dxToolbar("instance"),t.dxScrollView({height:"100%",width:"100%"}).dxScrollView("instance")):i.dxToolbar({items:[{toolbar:"bottom",widget:"dxButton",location:"before",options:{text:"valider",stylingMode:"contained",type:"success",validationGroup:"formTimeResult",onClick:function t(a){if(!0===a.validationGroup.validate().isValid){let i=s.option("dataSource");e.component.updateAppointment(e.appointmentData,$.extend(e.appointmentData,{sdc:i}));let o={};o.data=i,o.structure=e.appointmentData.devis.structure,o.appointmentID=e.appointmentData.id,ee("createSuiviChantier",o=JSON.stringify(o)),u.hide()}}}},{toolbar:"bottom",widget:"dxButton",location:"after",options:{text:"Annuler",stylingMode:"contained",type:"success",onClick(){u.hide()}}}]}).dxToolbar("instance"),t}}}function k(e){let t;return{contentTemplate(){let a=$("<div />"),i=$("<div />").addClass("form-arrive").appendTo(a),o=$("<div />").addClass("toolbar-arrive ja-toolbar").appendTo(a);return t=i.dxForm({readOnly:!1,showColonAfterLabel:!0,labelMode:"floating",labelLocation:"top",minColWidth:200,height:"auto",colCount:1,showValidationSummary:!1,validationGroup:"formTimeResult",items:[{itemType:"group",cssClass:"info-group",colCount:3,items:[{dataField:"date",label:{text:"Date",visible:!1},editorOptions:{value:K(new Date(e.appointmentData.startDate))},validationRules:[{type:"required",message:"requis"}]},{dataField:"heure_a",label:{text:"Heure d'arriv\xe9e",visible:!1},editorOptions:{value:H(),mode:"tel",mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"},validationRules:[{type:"required",message:"requis"}]},{dataField:"trajet",label:{text:"Temps de trajet",visible:!1},editorOptions:{value:""},validationRules:[{type:"required",message:"requis"}]}]}]}).dxForm("instance"),o.dxToolbar({items:[{widget:"dxButton",location:"before",toolbar:"bottom",options:{stylingMode:"contained",type:"success",text:"valider",validationGroup:"formTimeResult",onClick:function a(i){let o=i.validationGroup.validate(),n=[];if(!0===o.isValid){let l=t.option("formData");$.each(e.appointmentData.salarieID,(t,a)=>{let i={};x.load({filter:["id",a]}).done(t=>{let a=`${t[0].prenom} ${t[0].nom}`;i.salarie_name=a,i.dvs_ref=e.appointmentData.devis.dvs_ref,i.date=l.date,i.heure_a=l.heure_a,i.trajet=l.trajet,i.heure_d="",i.pause_a="",i.pause_d=""}),n.push(i)}),e.component.updateAppointment(e.appointmentData,$.extend(e.appointmentData,{sdc:n}));let d={};d.dvsRef=e.appointmentData.devis.dvs_ref,d.type=1,d.structure=e.appointmentData.devis.structure,d.hour=l.heure_a,d=JSON.stringify(d),console.log(d),ee("notification",d),u.hide()}}}},{widget:"dxButton",location:"after",toolbar:"bottom",options:{text:"Annuler",stylingMode:"contained",type:"success",onClick(){u.hide()}}}]}).dxToolbar("instance"),a}}}function M(e){let t;return{contentTemplate(){let a=$("<div />"),i=$("<div />").addClass("form-depart").appendTo(a),o=$("<div />").addClass("toolbar-depart ja-toolbar").appendTo(a);return t=i.dxForm({readOnly:!1,showColonAfterLabel:!0,labelMode:"floating",labelLocation:"top",minColWidth:200,height:"auto",colCount:1,showValidationSummary:!1,validationGroup:"formTimeResult",items:[{itemType:"group",cssClass:"info-group",colCount:3,items:[{dataField:"heure_d",label:{text:"heure de d\xe9part",visible:!1},editorOptions:{value:H(),mode:"tel",mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"},validationRules:[{type:"required",message:"requis"}]},{dataField:"pause_a",label:{text:"d\xe9but de pause",visible:!1},editorOptions:{mode:"tel",value:"",mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"}},{dataField:"pause_d",label:{text:"fin de pause",visible:!1},editorOptions:{mode:"tel",value:"",mask:"Hh:Mm",maskRules:N(),useMaskedValue:!0,showMaskMode:"onFocus"}}]}]}).dxForm("instance"),o.dxToolbar({items:[{widget:"dxButton",location:"before",toolbar:"bottom",options:{stylingMode:"contained",type:"success",text:"valider",validationGroup:"formTimeResult",onClick:function a(i){if(!0===i.validationGroup.validate().isValid){let o=t.option("formData");$.each(e.appointmentData.sdc,(e,t)=>{t.heure_d=o.heure_d,t.pause_a=o.pause_a,t.pause_d=o.pause_d}),e.component.updateAppointment(e.appointmentData,e.appointmentData);let n={};n.data=e.appointmentData.sdc,n.structure=e.appointmentData.devis.structure,n.appointmentID=e.appointmentData.id,ee("createSuiviChantier",n=JSON.stringify(n));let l={};l.dvsRef=e.appointmentData.devis.dvs_ref,l.type=2,l.structure=e.appointmentData.devis.structure,l.hour=o.heure_d,l=JSON.stringify(l),console.log(l),ee("notification",l),u.hide()}}}},{widget:"dxButton",location:"after",toolbar:"bottom",options:{text:"Annuler",stylingMode:"contained",type:"success",onClick(){u.hide()}}}]}).dxToolbar("instance"),a}}}function A(e){$.each(e,(e,t)=>{let a=JSON.parse(t.fieldData.appointmentJSON_return);h.push([{type:"insert",data:a,index:e}])})}function B(e){$.each(e,(e,t)=>{let a=JSON.parse(t.fieldData.equipeJSON_new);f.push([{type:"insert",data:a,index:e}])}),D.option("resources[0].dataSource",J(i))}function R(e){$.each(e,(e,t)=>{let a=JSON.parse(t.fieldData.officeJSON_new);b.push([{type:"insert",data:a,index:e}])})}function E(e){$.each(e,(e,t)=>{let a=JSON.parse(t.fieldData.salarieJSON_new);x.push([{type:"insert",data:a,index:e}])})}function I(e){let t=new class e{constructor(e,t,a){this.param=e,this.title=a,this.func=t,this.startPopup=()=>{if(u)u.option({contentTemplate:t(e).contentTemplate.bind(this),title:a}),u.option(P());else{let i=$("<div />").attr("id","popup").appendTo("#planning");(u=i.dxPopup(t(e)).dxPopup("instance")).option(P()),u.option("title",a)}u.show()}}}(e.param.param,e.param.func,e.param.title);t.startPopup()}function P(){let e={showTitle:!0,fullScreen:!0,visible:!1,dragEnabled:!0,closeOnOutsideClick:!0,showCloseButton:!0,shading:!0,shadingColor:"rgba(134, 134, 134, 0.70)",wrapperAttr:{class:"popup"},animation:W()};return e}function V(e){return e.appointmentData.sdc?e.appointmentData.sdc[0].heure_a&&!e.appointmentData.sdc[0].heure_d?[{name:"button_detail",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"D\xe9part",type:"success",elementAttr:{class:"button-depart"},visible:!0,onClick(){I({param:{func:M,param:e,title:"D\xe9part du chantier"}})}}}]:void 0:[{name:"button_detail",label:{visible:!1},editorType:"dxButton",editorOptions:{width:"100%",text:"Arriv\xe9",type:"success",elementAttr:{class:"button-arrive"},visible:!0,onClick(){I({param:{func:k,param:e,title:"Arriv\xe9 sur le chantier"}})}}}]}function j(e,t){if(!t)return!0;{let a=e.split("/");var i=new Date(a[2],a[1]-1,a[0]),o=t.split(":");i.setHours(o[0]),i.setMinutes(o[1]);let n;return!(new Date-i>1728e5)}}function q(e){let t=[];return $.each(e.appointmentData.salarieID,(e,a)=>{x.load({filter:["id",a]}).done(e=>{let a=` ${e[0].prenom} `;t.push(a)})}),t}function N(){return{H:e=>e>=0&&e<=2,h:(e,t,a)=>"2"==a[0]?[0,1,2,3].includes(parseInt(e)):[0,1,2,3,4,5,6,7,8,9].includes(parseInt(e)),M:e=>e>=0&&e<=5,m:e=>e>=0&&e<=9}}function H(){let e=new Date,t=e.getHours(),a=e.getMinutes();return(r=a%5)<3?a-=r:a+=5-r,60==a&&(a=0,t+=1),`${t=t<10?`0${t}`:t}:${a=a<10?`0${a}`:a}`}function L(){let e=$(".dx-scheduler-date-table-cell").width();$(".dx-scheduler-appointment-vertical").width(e+1.6)}function G(){return(m-116)/21-1}function z(){$(".dx-scheduler-view-switcher").remove(),$(".dx-scheduler-view-switcher-label").remove()}function J(e){let t=[];return f._array.length>0?$.each(e,(e,a)=>{let i=$.grep(f._array,e=>e.id===a);t.push(i[0])}):t=[{id:"1"}],t}function W(){return{show:{type:"slide",duration:400,from:{position:{my:"left",at:"right",of:"#planning"}}},hide:{type:"slide",duration:400,to:{position:{my:"left",at:"right",of:"#planning"}}}}}function U(e){let t=e.getMonth()+1,a=e.getDate();return e.getFullYear()+"/"+t+"/"+a}function Y(e){let t=e.getMonth()+1,a=e.getDate(),i;return a<10&&(a="0"+a),t<10&&(t="0"+t),a+"/"+t+"/"+e.getFullYear()}function K(e){let t=e.getMonth()+1,a=e.getDate(),i=e.getFullYear();return e.getHours(),e.getMinutes(),e.getSeconds(),a<10&&(a=`0${a}`),t<10&&(t=`0${t}`),`${a}/${t}/${i}`}function Q(e,t,a,i,o){let n={};return n.base=e,n.layout=t,n.para=a,n.field=i,$.ajax({url:"./lib/php/getTheData.php",method:"POST",data:n,dataType:"JSON"}).done(e=>{o(e)}),!0}async function X(e,t){let a=new FormData;a.append("base",e),a.append("layout",t);let i=await fetch("./lib/php/getTheData.php",{method:"POST",body:a}),o=await i.json();return $.each(o,(e,t)=>{let a=JSON.parse(t.fieldData.clt_json_plann);y.push([{type:"insert",data:a,index:e}])}),!0}function Z(e,t,a,i){let o={};return o.base=e,o.layout=t,o.para=a,o.field=i,$.ajax({url:"./lib/php/getTheData.php",method:"POST",data:o,dataType:"JSON"}).done(e=>(I({param:{func:C,param:e[0].fieldData,title:"Info client"}}),e)),!0}function ee(e,t){let a={};return a.script=e,a.param=t,$.ajax({url:"./lib/php/runScript.php",method:"POST",data:a,dataType:"JSON"}).done(e=>{}),!0}z()});